# RoA2 Portrait Shuffler (Rust + WASM + React)

A dual-panel character randomizer built with **Rust**, **WASM**, and **React**, designed for quickly generating “sets” of shuffled Rivals of Aether 2 character portraits. Each side randomizes independently and supports toggling characters grey or un-grey by clicking them.

This project also uses a **pyramid layout** to visually organize portraits in a 5 / 4 / 3 / 2 pattern.

---

## Features

### ✔ Two independent randomizers
- **Player 1** and **Player 2** areas  
- Each panel has its own **Randomize** and **Undo** buttons  
- Undo restores the previous arrangement  

### ✔ Rust-powered shuffling
- Portrait indices are shuffled using a Rust function compiled into WASM  
- JavaScript triggers the shuffle via exported WASM bindings  

### ✔ Click to Greyscale
- Clicking any portrait toggles grayscale on/off  
- Greyscale state persists through shuffles  

### ✔ Pyramid Layout
Each side displays portraits in a fixed layout:

```
⬤ ⬤ ⬤ ⬤ ⬤
  ⬤ ⬤ ⬤ ⬤
    ⬤ ⬤ ⬤
      ⬤ ⬤
```

### ✔ Responsive UI
- Side-by-side layout on wide screens  
- Automatically collapses into vertical stacking on small screens  
- Both pyramids remain centered in their respective columns  

---

## Tech Stack

| Layer | Technology |
|-------|------------|
| UI Framework | React (Vite) |
| Shuffle Logic | Rust + wasm-bindgen + wasm-pack |
| Portraits | Static assets in `/public/portraits` |
| State Management | useState + custom logic |
| Build Tools | Vite bundler, wasm-pack (`--target web`) |

---

## Project Structure

```
portrait_shuffler/
│
├── src-tauri/
│   ├── src/lib.rs         # Run-state commands exposed to the UI
│   └── tauri.conf.json    # Desktop window + bundler config
│
├── src/
│   ├── App.tsx
│   ├── components/
│   │   └── portrait-shuffler.tsx
│   ├── assets/
│   │   └── portrait-constants.ts
│   └── pkg/               # Generated by wasm-pack
│
├── public/
│   └── portraits/         # Character images
│
├── Cargo.toml             # Rust crate config
└── src/lib.rs             # Rust shuffle function
```

---

## Desktop Shell (Tauri)

This repo now doubles as a desktop app: Tauri wraps the existing React UI, links directly against the Rust shuffle crate, and keeps long-lived Iron Man run state in the backend. That unlocks:

- Shared logic between the browser build and the native shell (no duplicated RNG).
- IPC commands for starting/resetting runs, marking characters complete, and sharing history with future CV or DB workers.
- Space to add local resources (SQLite, computer-vision polling, stream overlays) without bloating the UI bundle.

You can still run the browser-only flow, but the recommended development loop is to let Tauri spawn the frontend dev server and operate the app within the native window.

---

## How to Build & Run

### 1. Install Rust and wasm-pack

```bash
brew install rustup
rustup-init

cargo install wasm-pack
```

### 2. Build the WASM module

From the project root:

```bash
cd /Users/guadac01/Repos/ironman-randomizer/portrait_shuffler

wasm-pack build \
    --target web \
    --out-dir frontend/src/pkg \
    --out-name portrait_shuffler
```

This generates:

```
portrait_shuffler.js
portrait_shuffler_bg.wasm
portrait_shuffler.d.ts
```

### 3. Install frontend deps

```bash
cd frontend
npm install
```

### 4. Run the dev server

```bash
npm run dev
```

Open:

```
http://localhost:5173/
```

### 5. Launch the desktop shell

```bash
# from the repo root
cargo tauri dev
```

This runs the frontend dev server (via `npm run dev`), boots Tauri, and wires the React UI to the new backend commands. To create a distributable desktop binary, run `cargo tauri build`.

---

## How the WASM Shuffle Works

Rust (`src/lib.rs`):

```rust
#[wasm_bindgen]
pub fn shuffled_indices(len: usize, seed: u32) -> Vec<u32> {
    let mut rng = StdRng::seed_from_u32(seed);
    let mut indices: Vec<u32> = (0..len as u32).collect();
    indices.shuffle(&mut rng);
    indices
}
```

- The Rust function returns a permutation of 0..N.
- JS uses this to reorder portrait indices.
- Shuffles are independent for each panel.

The Tauri backend links against the same crate, so desktop commands and WASM stay in sync.

---

## Rust Backend Commands (Tauri)

The desktop shell exposes a few IPC commands inside `src-tauri/src/lib.rs` that the UI (or future automation workers) can invoke:

```
```1:107:src-tauri/src/lib.rs
#[tauri::command]
fn start_run(characters: Vec<String>, seed: Option<u32>, state: State<SharedRunState>) -> RunState { /* ... */ }

#[tauri::command]
fn complete_character(character: Option<String>, state: State<SharedRunState>) -> RunState { /* ... */ }

#[tauri::command]
fn fail_run(state: State<SharedRunState>) -> RunState { /* ... */ }
```
```

- `shuffle_characters`: produce RNG-stable orderings directly from Rust.
- `start_run`: persist queue/metadata for a new Iron Man attempt.
- `complete_character`: remove the head (or named entry) from the queue and append it to the completed list.
- `fail_run`, `reset_run`, `get_run_state`: manage lifecycle and surface the latest snapshot to the UI.

Because the state lives in Rust, it's ready for enhancements like local persistence, auto-tracking via computer vision, or emitting overlay events without rewriting frontend logic.

---

## Portrait Greyscaling

Each portrait index has a boolean:

```ts
const [greyed, setGreyed] = useState<boolean[]>(
    () => portraits.map(() => false)
);
```

Clicking toggles grayscale via CSS:

```css
filter: grayscale(100%);
```

---

## Undo Behavior

Before each shuffle:

```ts
setPreviousOrder(order);
```

Undo restores it:

```ts
setOrder(previousOrder);
setPreviousOrder(null);
```

Undo is per-shuffler and does not affect the other side.

---

## Responsive Layout

The app switches between horizontal and vertical layouts depending on window width:

```ts
const BREAKPOINT = 1120;
setIsVertical(window.innerWidth < BREAKPOINT);
```

Portrait pyramids remain centered using:

```css
align-self: center;
margin-left: rowIndex * 40px;
```

---

## Adding or Renaming Characters

Edit:

```
src/assets/portrait-constants.ts
```

Example:

```ts
export const PORTRAITS = [
	"/portraits/240px-RoA2_Icon_Absa.webp",
	"/portraits/240px-RoA2_Icon_Ranno.webp",
	...
];
```

Images in `public/portraits` load automatically.

---

## Known Limitations

- Undo only saves **one** previous state  
- Pyramid indent requires tuning if portrait sizes change  
